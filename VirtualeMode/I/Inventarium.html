<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventarium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#000; --fg:#7F7F7F;
      --gap:12px;                 /* タイル間余白 */
      --area: 0.70710678;         /* 画面長辺に対する正方形割合 (70.710678%) */
      --imgScale: 0.6180339;      /* タイル内画像スケール (61.80339%) */
    }
    html,body{
      margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:Georgia,serif;
    }
    /* 画面中央に正方形エリアを置く */
    .stage{
      height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;
    }
    .square{
      /* 画面の長辺×割合の正方形 */
      width: calc(max(100vw, 100vh) * var(--area));
      height: calc(max(100vw, 100vh) * var(--area));
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
      gap: 10px;
    }
    /* 記号ボタン（ユニバーサル） */
    .controls{
      display:flex;gap:14px;align-items:center;justify-content:center;
    }
    .btn{
      width:38px;height:32px;display:flex;align-items:center;justify-content:center;
      background:#111;border:1px solid var(--fg);color:var(--fg);
      cursor:pointer;font-size:18px;line-height:1;user-select:none;
    }
    .btn:hover{ background:#222; }
    /* 4×4 正方グリッド（正方形内にぴったり収める） */
    .grid{
      flex:1; width:100%; height:100%;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: var(--gap);
      align-items:center; justify-items:center;
    }
    .cell{
      width:100%; height:100%;
      background:#111;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; /* 念のため */
    }
    .cell img{
      max-width: calc(100% * var(--imgScale));
      max-height: calc(100% * var(--imgScale));
      object-fit: contain;
      display:block;
      margin:auto;
    }
    /* 分数風ステータス */
    .status{
      display:flex;align-items:center;justify-content:center;
      height:36px; font-size:14px; opacity:.9;
    }
    .frac{
      display:flex;flex-direction:column;align-items:center;line-height:1;
    }
    .frac .bar{
      width:28px;height:1px;background:var(--fg);margin:6px 0 5px;
      opacity:.7;
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="square">
      <div class="controls">
        <button id="nextBtn" class="btn" aria-label="Next batch">▶︎</button>
        <button id="resetBtn" class="btn" aria-label="Reset">⟲</button>
      </div>

      <div id="grid" class="grid" aria-live="polite"></div>

      <div class="status">
        <div class="frac">
          <span id="shown">0</span>
          <span class="bar"></span>
          <span id="total">0</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ←← あなたの Archive.org アイテムID
    const ARCHIVE_ID = "36338-d-7-c-f-335-44-f-9-8-cbb-ab-577004-d-1-ec";

    const GRID_SIZE = 16; // 4×4 固定
    const gridEl   = document.getElementById("grid");
    const shownEl  = document.getElementById("shown");
    const totalEl  = document.getElementById("total");
    let allUrls = [], shuffled = [], cursor = 0;

    async function fetchArchiveFileList(id){
      const res = await fetch(`https://archive.org/metadata/${encodeURIComponent(id)}`);
      if(!res.ok) throw new Error("Failed to fetch archive metadata");
      const data = await res.json();
      const exts = new Set(["jpg","jpeg","png","gif","webp","jp2","tif","tiff"]);
      return (data.files||[])
        .filter(f=>{
          const name = (f.name||"").toLowerCase();
          const m = name.match(/\.([a-z0-9]+)$/);
          const byExt = m && exts.has(m[1]);
          const fmt = (f.format||"").toLowerCase();
          const byFmt = /(image|jpeg|png|gif|jp2|tiff)/.test(fmt);
          return byExt || byFmt;
        })
        .map(f=> `https://archive.org/download/${id}/${encodeURIComponent(f.name)}`);
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function renderBatch(){
      gridEl.innerHTML = "";

      if(cursor >= shuffled.length){
        // すべて表示済み：最後の状態を維持（ボタンでReset可能）
        shownEl.textContent = shuffled.length;
        totalEl.textContent = shuffled.length;
        return;
      }

      const end   = Math.min(cursor + GRID_SIZE, shuffled.length);
      const batch = shuffled.slice(cursor, end);

      // 16枠を必ず埋める（不足分は空セル）
      for(let i=0;i<GRID_SIZE;i++){
        const cell = document.createElement("div");
        cell.className = "cell";
        if(i < batch.length){
          const img = document.createElement("img");
          img.src = batch[i];
          img.alt = "#i archive image";
          img.loading = "lazy";       // 軽量化
          img.decoding = "async";
          img.fetchPriority = "low";
          cell.appendChild(img);
        }
        gridEl.appendChild(cell);
      }

      cursor = end;
      shownEl.textContent = end;
      totalEl.textContent = shuffled.length;
    }

    function resetAll(){
      cursor = 0;
      shuffled = shuffle(allUrls);
      shownEl.textContent = 0;
      totalEl.textContent = shuffled.length;
      renderBatch();
    }

    document.getElementById("nextBtn").addEventListener("click", renderBatch);
    document.getElementById("resetBtn").addEventListener("click", resetAll);

    (async () => {
      try{
        allUrls = await fetchArchiveFileList(ARCHIVE_ID);
        if(!allUrls.length){
          totalEl.textContent = 0;
          return;
        }
        totalEl.textContent = allUrls.length;
        resetAll();
      }catch(e){
        console.error(e);
        totalEl.textContent = 0;
      }
    })();
  </script>
</body>
</html>
