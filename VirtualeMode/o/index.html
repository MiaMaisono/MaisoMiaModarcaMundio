<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>#o â€“ Ï»iapolğ¯o</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html, body { margin:0; height:100%; background:#000; overflow:hidden; }
  canvas#sky { position:fixed; inset:0; display:block; background:#000; z-index:0; pointer-events:none; }

  /* ä¸­å¤®ãƒªãƒ³ã‚¯ã¯å°ã•ãªâ­ï¸ã ã‘ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰ */
  .center {
    position:relative; z-index:1; height:100%;
    display:grid; place-items:center;
  }
  .links {
    display:flex; gap:3.5em; align-items:center; justify-content:center;
  }
  .links a {
    text-decoration:none; color:#7F7F7F;
    font-style:italic; /* æ—¢å­˜æ–¹é‡ã‚’è¸è¥² */
    -webkit-tap-highlight-color:rgba(255,255,255,0.1);
  }
  .links a .starlink {
    display:inline-block; line-height:1; user-select:none;
    /* ç”»é¢ã‚µã‚¤ã‚ºã«è¿½éšã—ã¦å°ã•ã‚ã«ä¿ã¤ */
    font-size: min(3.0vw, 28px);
  }
  .links a:hover .starlink { text-decoration:underline; }
  .links a:focus-visible { outline:2px dashed #7F7F7F; outline-offset:6px; }
</style>
</head>
<body>
  <canvas id="sky" aria-hidden="true"></canvas>

  <!-- ãƒ†ã‚­ã‚¹ãƒˆã¯å‡ºã•ãšã€å°ã•ãªâ­ï¸ã ã‘ã§ãƒªãƒ³ã‚¯ -->
  <div class="center">
    <nav class="links" aria-label="primary">
      <a href="https://opensea.io/item/ethereum/0xd91cd9974a4e19e4d23a4a2d94e2e5dd172eee8d/2" target="_blank" rel="noopener" title="Femme">
        <span class="starlink">â­ï¸</span>
      </a>
      <a href="https://opensea.io/item/ethereum/0xd91cd9974a4e19e4d23a4a2d94e2e5dd172eee8d/1" target="_blank" rel="noopener" title="Homme">
        <span class="starlink">â­ï¸</span>
      </a>
    </nav>
  </div>

<script>
/* =========================
   ç”»åƒâ†’â­ï¸ åº§æ¨™ãƒ»ã‚µã‚¤ã‚ºæŠ½å‡º
   ========================= */
const SOURCE_IMAGE = 'sky-610-mecca-1728.png'; // â†ã‚¹ã‚¯ã‚·ãƒ§ã®ãƒ•ã‚¡ã‚¤ãƒ«å
const IMG_SIZE = 1728;                         // Your Sky å‡ºåŠ›ã‚µã‚¤ã‚º
const THRESH = 235;                            // ç™½åˆ¤å®š (R/G/B >= 235)
const STEP = 2;                                // èµ°æŸ»é–“éš”ï¼ˆè»½é‡ï¼‰
const MIN_BLOB = 1;                            // å°ã•ã™ãã‚‹ãƒã‚¤ã‚ºé™¤å¤–
const MAX_BLOB = 100;                          // å¤§ãã™ãã‚‹å¡Šé™¤å¤–ï¼ˆæ˜Ÿé›²ç­‰ï¼‰
const STAR_CHAR = 'â­ï¸';                        // æç”»ã™ã‚‹è¨˜å·
const STAR_COLOR = '#FFF';                     // æ˜Ÿã¯ç™½ã®ã¿

const canvas = document.getElementById('sky');
const ctx = canvas.getContext('2d');
let starNorms = [];     // æ­£è¦åŒ–åº§æ¨™ï¼†é‡ã¿ [{x,y,w}]
let starField = null;   // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«å›ºå®šæç”»
const meteors = [];     // æµã‚Œæ˜Ÿï¼ˆä»»æ„ï¼šå¿…è¦ãªã‚‰å¾Œã§è¶³ã›ã¾ã™ï¼‰

function fitCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  renderStarField();
}
window.addEventListener('resize', fitCanvas, { passive:true });

(async function init(){
  fitCanvas();
  await extractStarsFromImage();
  renderStarField();
})();

/* ç”»åƒã®ç™½ã„ç‚¹ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦é‡å¿ƒã¨é¢ç©ã‚’å–å¾— */
async function extractStarsFromImage() {
  const img = await loadImage(SOURCE_IMAGE);
  const off = document.createElement('canvas');
  off.width = IMG_SIZE; off.height = IMG_SIZE;
  const ox = off.getContext('2d');
  ox.drawImage(img, 0, 0, IMG_SIZE, IMG_SIZE);

  const cx = IMG_SIZE/2, cy = IMG_SIZE/2, R = IMG_SIZE/2;
  const src = ox.getImageData(0, 0, IMG_SIZE, IMG_SIZE);
  const mask = new Uint8Array(IMG_SIZE * IMG_SIZE);

  for (let y=0; y<IMG_SIZE; y+=STEP){
    const dy = y - cy, dy2 = dy*dy;
    for (let x=0; x<IMG_SIZE; x+=STEP){
      const dx = x - cx;
      if (dx*dx + dy2 > R*R) continue; // å††å¤–ã¯ç„¡è¦–
      const i = (y*IMG_SIZE + x) * 4;
      const r = src.data[i], g = src.data[i+1], b = src.data[i+2];
      if (r>=THRESH && g>=THRESH && b>=THRESH) mask[y*IMG_SIZE + x] = 1;
    }
  }

  // é€£çµæˆåˆ†ãƒ©ãƒ™ãƒªãƒ³ã‚° (BFS on STEPã‚°ãƒªãƒƒãƒ‰)
  const visited = new Uint8Array(mask.length);
  const stars = [];
  const qx = [], qy = [];

  for (let y0=0; y0<IMG_SIZE; y0+=STEP){
    for (let x0=0; x0<IMG_SIZE; x0+=STEP){
      const idx0 = y0*IMG_SIZE + x0;
      if (!mask[idx0] || visited[idx0]) continue;

      let sumX=0, sumY=0, count=0;
      let head=0, tail=0;
      qx[tail]=x0; qy[tail]=y0; tail++;
      visited[idx0]=1;

      while (head<tail){
        const x=qx[head], y=qy[head]; head++;
        const idx=y*IMG_SIZE + x;
        sumX+=x; sumY+=y; count++;

        neigh(x+STEP, y); neigh(x-STEP, y);
        neigh(x, y+STEP); neigh(x, y-STEP);

        function neigh(nx, ny){
          if (nx<0||ny<0||nx>=IMG_SIZE||ny>=IMG_SIZE) return;
          const nidx = ny*IMG_SIZE + nx;
          if (!mask[nidx] || visited[nidx]) return;
          visited[nidx]=1; qx[tail]=nx; qy[tail]=ny; tail++;
        }
      }

      if (count>=MIN_BLOB && count<=MAX_BLOB){
        const gx = sumX / count, gy = sumY / count;
        const dx = gx - cx, dy = gy - cy;
        if (dx*dx + dy*dy <= (R-2)*(R-2)) {
          stars.push({ x: gx/IMG_SIZE, y: gy/IMG_SIZE, w: count });
        }
      }
    }
  }

  // é¢ç©ã®ãƒ¬ãƒ³ã‚¸ã‚’æ¸¬ã£ã¦ã€â­ï¸ã‚µã‚¤ã‚ºã®æ¯”ç‡ã«åæ˜ 
  const wMin = Math.min(...stars.map(s=>s.w));
  const wMax = Math.max(...stars.map(s=>s.w));
  // å®‰å®šåŒ–ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  const eps = 0.0001;
  starNorms = stars.map(s=>{
    const t = (s.w - wMin) / Math.max(eps, (wMax - wMin)); // 0..1
    return { x:s.x, y:s.y, w:s.w, t };
  });

  console.log(`Stars detected: ${starNorms.length}, blob range: [${wMin}, ${wMax}]`);
}

/* æ­£è¦åŒ–åº§æ¨™ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«æŠ•å½±ã—ã€â­ï¸ã‚’ç­‰ç´šã£ã½ãã‚µã‚¤ã‚ºå‡ºã—ã—ã¦å›ºå®šæç”» */
function renderStarField() {
  if (!starNorms.length) return;
  const w = canvas.width, h = canvas.height;
  const size = Math.min(w, h);               // æ­£å††ã§ãƒ•ã‚£ãƒƒãƒˆ
  const ox = new OffscreenCanvas ? new OffscreenCanvas(w, h) : document.createElement('canvas');
  ox.width = w; ox.height = h;
  const octx = ox.getContext('2d');

  // èƒŒæ™¯
  octx.fillStyle = '#000';
  octx.fillRect(0, 0, w, h);

  // å††å½¢ã‚¯ãƒªãƒƒãƒ—
  octx.save();
  octx.beginPath();
  octx.arc(w/2, h/2, size/2, 0, Math.PI*2);
  octx.clip();

  // â­ï¸ã®ã‚µã‚¤ã‚ºã¯ã€Œæœ€å°6pxã€œæœ€å¤§14pxã€ã‚’ç›®å®‰ã«ã€blobé¢ç©ã«æ¯”ä¾‹
  const pxMin = 6 * (size/IMG_SIZE);
  const pxMax = 14 * (size/IMG_SIZE);

  octx.fillStyle = STAR_COLOR;
  octx.textAlign = 'center';
  octx.textBaseline = 'middle';

  const offX = (w - size)/2, offY = (h - size)/2;

  for (let i=0;i<starNorms.length;i++){
    const s = starNorms[i];
    const fs = pxMin + (pxMax - pxMin) * Math.pow(s.t, 0.65); // æ˜ã‚‹ã‚ã‚’å°‘ã—å¼·èª¿
    octx.font = `${fs}px serif`;
    const sx = offX + s.x * size;
    const sy = offY + s.y * size;
    octx.fillText(STAR_CHAR, sx, sy);
  }

  octx.restore();

  // ç”»é¢ã¸è»¢é€
  if (ox.transferToImageBitmap) {
    const bmp = ox.transferToImageBitmap();
    // ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦è²¼ã‚‹
    ctx.clearRect(0,0,w,h);
    createImageBitmap(bmp).then(()=>{ ctx.drawImage(bmp,0,0); });
    starField = bmp;
  } else {
    starField = ox;
    ctx.clearRect(0,0,w,h);
    ctx.drawImage(starField, 0, 0);
  }
}

/* ç”»åƒãƒ­ãƒ¼ãƒ€ */
function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = src;
  });
}
</script>
</body>
</html>